#!/bin/bash

# Verificar que se proporcionaron uno o dos argumentos
if [ $# -lt 1 ] || [ $# -gt 2 ]; then
    echo "Uso: $0 archivo_o_carpeta [archivo_json]"
    exit 1
fi

# Verificar que el archivo o carpeta existe
if [ ! -e "$1" ]; then
    echo "Error: archivo o carpeta no encontrado"
    exit 1
fi

# Verificar si se proporcionó un archivo JSON
if [ $# -eq 2 ]; then
    # Verificar que el archivo JSON existe
    if [ ! -f "$2" ]; then
        echo "Error: archivo JSON no encontrado"
        exit 1
    fi

    # Leer el archivo JSON
    herramientas=$(jq -r '.herramientas[]' "$2")
    archivo=$(jq -r '.ruta[]' "$2")
fi

# Crear un directorio para los resultados
dir_resultados=$(date +%Y%m%d_%H%M%S)
mkdir Experimentos/"$dir_resultados"

# Realizar el análisis estático
if [ -d "$1" ]; then
    # Analizar todos los archivos en la carpeta con exiftool
    for archivo in "$1"/*; do
        if [ -f "$archivo" ]; then
            resultado=$(exiftool "$archivo")
            echo "$resultado" > "Experimentos/${dir_resultados}/${archivo##*/}_$(date +%Y%m%d_%H%M%S).txt"
        fi
    done
elif [ -f "$1" ]; then
    # Analizar el archivo con exiftool
    resultado=$(exiftool "$1")
    echo "$resultado" > "Experimentos/${dir_resultados}/${1##*/}_$(date +%Y%m%d_%H%M%S).txt"
fi

if [ -n "$herramientas" ]; then
    # Ejecutar otras herramientas según las indicaciones del archivo JSON
    for herramienta in $herramientas; do
        case $herramienta in
            "md5sum")
                resultado=$(md5sum "$1")
                ;;
            "sha1sum")
                resultado=$(sha1sum "$1")
                ;;
            "sha256sum")
                resultado=$(sha256sum "$1")
                ;;
            *)
                echo "Error: herramienta desconocida"
                exit 1
        esac
        echo "$resultado" > "Experimentos/${dir_resultados}/${herramienta}_$(date +%Y%m%d_%H%M%S).txt"
    done
fi

echo "Resultados almacenados en el directorio Experimentos/${dir_resultados}"
